{% extends "base.html" %}

{% block title %}Dashboard - Financeira Aut√™ntica{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="bi bi-speedometer2 text-primary me-2"></i>
                Dashboard Principal
            </h1>
        </div>
    </div>
</div>

<!-- Cards de Navega√ß√£o -->
<div class="row">
    <div class="col-xl-6 col-md-6 mb-4">
        <div class="card border-0 shadow h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-primary bg-gradient rounded-circle p-3">
                            <i class="bi bi-people text-white fs-4"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1">Total de Clientes</h6>
                        <h3 class="mb-2" id="total-clients-count">
                            <span class="loading-placeholder">{{ stats.total_clients | default('...') }}</span>
                        </h3>
                        <a href="{{ url_for('clients') }}" class="btn btn-primary btn-sm nav-preloader-link">
                            <i class="bi bi-people me-1"></i>Ver Clientes
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-6 col-md-6 mb-4">
        <div class="card border-0 shadow h-100">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-info bg-gradient rounded-circle p-3">
                            <i class="bi bi-tools text-white fs-4"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1">Servi√ßos</h6>
                        <h3 class="mb-2">Dashboard</h3>
                        <a href="{{ url_for('services') }}" class="btn btn-info btn-sm nav-preloader-link">
                            <i class="bi bi-tools me-1"></i>Ver Servi√ßos
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estat√≠sticas dos Clientes -->
<div class="row" id="dashboard-stats-section">
    <div class="col-lg-8">
        <div class="card border-0 shadow mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bar-chart"></i> Resumo de Clientes
                </h5>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="refreshDashboardStats()" title="Recarregar estat√≠sticas">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <div class="dashboard-loading-indicator" id="stats-loading" style="display: none;">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="text-center">
                            <h6 class="text-muted">Clientes Ativos</h6>
                            <h2 class="text-success" id="active-clients-count">
                                {% if stats %}{{ stats.active_clients | default(0) }}{% else %}<span class="loading-placeholder">...</span>{% endif %}
                            </h2>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="text-center">
                            <h6 class="text-muted">Clientes Inativos</h6>
                            <h2 class="text-warning" id="inactive-clients-count">
                                {% if stats %}{{ stats.inactive_clients | default(0) }}{% else %}<span class="loading-placeholder">...</span>{% endif %}
                            </h2>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <div class="text-center">
                            <h6 class="text-muted">Pessoa F√≠sica</h6>
                            <h2 class="text-info" id="pessoa-fisica-count">
                                {% if stats %}{{ stats.pessoa_fisica | default(0) }}{% else %}<span class="loading-placeholder">...</span>{% endif %}
                            </h2>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center">
                            <h6 class="text-muted">Pessoa Jur√≠dica</h6>
                            <h2 class="text-primary" id="pessoa-juridica-count">
                                {% if stats %}{{ stats.pessoa_juridica | default(0) }}{% else %}<span class="loading-placeholder">...</span>{% endif %}
                            </h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card border-0 shadow mb-4">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-geo-alt"></i> Clientes por Estado
                </h5>
            </div>
            <div class="card-body" id="states-breakdown">
                {% if stats and stats.by_state %}
                    {% set state_items = stats.by_state.items() | list %}
                    {% for state, count in state_items[:5] %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ state }}</span>
                        <span class="badge bg-primary">{{ count }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="loading-placeholder-text">Carregando dados por estado...</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Sistema de Carregamento Progressivo -->
<div class="row mb-4" id="progressive-loading-section" style="display: none;">
    <div class="col-12">
        <div class="card border-0 shadow">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-arrow-clockwise"></i> Carregamento Inteligente
                </h5>
            </div>
            <div class="card-body">
                <div id="progressive-stages-container"></div>
                <div id="progressive-info-container"></div>
                <div class="progressive-controls">
                    <button class="progressive-btn primary" onclick="startProgressiveLoad()">
                        <i class="fas fa-rocket"></i>
                        Carregar com Progresso
                    </button>
                    <button class="progressive-btn" onclick="showCacheStats()">
                        <i class="fas fa-chart-bar"></i>
                        Estat√≠sticas de Cache
                    </button>
                    <button class="progressive-btn" onclick="clearIntelligentCache()">
                        <i class="fas fa-trash"></i>
                        Limpar Cache
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estat√≠sticas de Cache -->
<div class="row mb-4" id="cache-stats-section" style="display: none;">
    <div class="col-12">
        <div class="card border-0 shadow">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-speedometer2"></i> Performance e Cache
                </h5>
            </div>
            <div class="card-body">
                <div id="cache-stats-container" class="cache-stats">
                    <!-- Estat√≠sticas ser√£o carregadas aqui -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- A√ß√µes R√°pidas -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightning"></i> A√ß√µes R√°pidas
                </h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleProgressiveFeatures()">
                    <i class="fas fa-cog"></i> Recursos Avan√ßados
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="d-grid">
                            <a href="{{ url_for('clients') }}" class="btn btn-outline-primary nav-preloader-link">
                                <i class="bi bi-people me-2"></i>
                                Gerenciar Clientes
                            </a>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="d-grid">
                            <a href="{{ url_for('services') }}" class="btn btn-outline-info nav-preloader-link">
                                <i class="bi bi-tools me-2"></i>
                                Dashboard de Servi√ßos
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.loading-placeholder {
    color: #6c757d;
    font-style: italic;
    animation: pulse 1.5s ease-in-out infinite alternate;
}

.loading-placeholder-text {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 1rem;
    animation: pulse 1.5s ease-in-out infinite alternate;
}

@keyframes pulse {
    from { opacity: 0.6; }
    to { opacity: 1; }
}

.dashboard-loading-indicator {
    transition: opacity 0.3s ease;
}

.state-item {
    transition: all 0.3s ease;
}

.state-item:hover {
    background-color: rgba(0, 123, 255, 0.1);
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    margin: -0.25rem -0.5rem 0.5rem -0.5rem;
}

/* Anima√ß√£o para contadores */
#dashboard-stats-section h2 {
    transition: all 0.3s ease;
}

/* Feedback visual para carregamento */
.loading-feedback {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    color: white;
    font-weight: 500;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.loading-feedback.show {
    opacity: 1;
    transform: translateX(0);
}

.loading-feedback.success {
    background-color: #198754;
}

.loading-feedback.error {
    background-color: #dc3545;
}

.loading-feedback.warning {
    background-color: #fd7e14;
}

.loading-feedback.info {
    background-color: #0dcaf0;
}

.feedback-icon {
    margin-right: 0.5rem;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// Vari√°veis globais para o dashboard
let progressiveUI;
let cacheStatsVisible = false;

document.addEventListener('DOMContentLoaded', function() {
    // Garantir que o preloader apare√ßa no dashboard inicial
    console.log('Dashboard carregado - verificando preloader');
    
    // Inicializar UI progressiva se dispon√≠vel
    if (typeof progressiveLoader !== 'undefined') {
        progressiveUI = new ProgressiveUI(progressiveLoader);
        console.log('‚úÖ UI progressiva inicializada');
    }
    
    // Carregar estat√≠sticas assincronamente
    loadDashboardStatsAsync();
    
    // Adicionar efeito de fade-in para os cards ap√≥s o carregamento
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100 * index);
    });
    
    // Carregar estat√≠sticas de cache automaticamente se dispon√≠vel
    loadCacheStatsIfAvailable();
});

/**
 * Carrega estat√≠sticas do dashboard de forma ass√≠ncrona
 */
async function loadDashboardStatsAsync() {
    try {
        // Mostrar indicador de carregamento
        const loadingIndicator = document.getElementById('stats-loading');
        if (loadingIndicator) {
            loadingIndicator.style.display = 'block';
        }
        
        // Primeiro, tentar carregar do cache r√°pido
        console.log('üîÑ Tentando carregar estat√≠sticas do cache...');
        let response = await fetch('/api/dashboard/quick-stats');
        let data = await response.json();
        
        if (data.status === 'success' && data.from_cache) {
            console.log('‚úÖ Estat√≠sticas carregadas do cache');
            updateDashboardStatsUI(data.data);
            hideLoadingIndicator();
            return;
        }
        
        // Se n√£o h√° cache, carregar da API
        console.log('üîÑ Carregando estat√≠sticas da API...');
        response = await fetch('/api/dashboard/stats');
        data = await response.json();
        
        if (data.status === 'success') {
            console.log('‚úÖ Estat√≠sticas carregadas da API');
            updateDashboardStatsUI(data.data);
            
            if (data.from_cache) {
                showNotification('Dados carregados do cache', 'success');
            } else {
                showNotification('Dados atualizados da API', 'info');
            }
        } else {
            throw new Error(data.error || 'Erro ao carregar estat√≠sticas');
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
        showNotification(`Erro ao carregar dados: ${error.message}`, 'error');
        
        // Manter placeholders em caso de erro
        updateDashboardStatsUI({
            total_clients: 'Erro',
            active_clients: 'Erro',
            inactive_clients: 'Erro',
            pessoa_fisica: 'Erro',
            pessoa_juridica: 'Erro',
            by_state: {}
        });
    } finally {
        hideLoadingIndicator();
    }
}

/**
 * Atualiza a interface com as estat√≠sticas carregadas
 */
function updateDashboardStatsUI(stats) {
    // Atualizar contadores principais
    updateElementText('total-clients-count', stats.total_clients || 0);
    updateElementText('active-clients-count', stats.active_clients || 0);
    updateElementText('inactive-clients-count', stats.inactive_clients || 0);
    updateElementText('pessoa-fisica-count', stats.pessoa_fisica || 0);
    updateElementText('pessoa-juridica-count', stats.pessoa_juridica || 0);
    
    // Atualizar breakdown por estado
    updateStatesBreakdown(stats.by_state || {});
    
    // Adicionar efeito de anima√ß√£o aos n√∫meros
    animateCounters();
}

/**
 * Atualiza texto de um elemento com anima√ß√£o
 */
function updateElementText(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        // Remover placeholder se existir
        const placeholder = element.querySelector('.loading-placeholder');
        if (placeholder) {
            placeholder.remove();
        }
        
        // Atualizar valor com anima√ß√£o
        element.style.opacity = '0.5';
        setTimeout(() => {
            element.textContent = value;
            element.style.opacity = '1';
        }, 150);
    }
}

/**
 * Atualiza breakdown por estado
 */
function updateStatesBreakdown(byState) {
    const container = document.getElementById('states-breakdown');
    if (!container) return;
    
    if (Object.keys(byState).length === 0) {
        container.innerHTML = '<p class="text-muted">Nenhum dado dispon√≠vel</p>';
        return;
    }
    
    // Ordenar estados por quantidade
    const sortedStates = Object.entries(byState)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5);
    
    const html = sortedStates.map(([state, count]) => `
        <div class="d-flex justify-content-between align-items-center mb-2 state-item">
            <span>${state}</span>
            <span class="badge bg-primary">${count}</span>
        </div>
    `).join('');
    
    container.innerHTML = html;
    
    // Animar entrada dos itens
    const items = container.querySelectorAll('.state-item');
    items.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-20px)';
        setTimeout(() => {
            item.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateX(0)';
        }, index * 100);
    });
}

/**
 * Anima contadores numericos
 */
function animateCounters() {
    const counters = document.querySelectorAll('#dashboard-stats-section h2');
    counters.forEach(counter => {
        const target = parseInt(counter.textContent) || 0;
        if (target > 0 && target < 10000) { // S√≥ animar n√∫meros razo√°veis
            let current = 0;
            const increment = target / 20;
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    counter.textContent = target;
                    clearInterval(timer);
                } else {
                    counter.textContent = Math.floor(current);
                }
            }, 50);
        }
    });
}

/**
 * Esconde indicador de carregamento
 */
function hideLoadingIndicator() {
    const loadingIndicator = document.getElementById('stats-loading');
    if (loadingIndicator) {
        loadingIndicator.style.display = 'none';
    }
}

/**
 * Recarrega estat√≠sticas manualmente
 */
async function refreshDashboardStats() {
    console.log('üîÑ Recarregando estat√≠sticas...');
    await loadDashboardStatsAsync();
}

/**
 * Alterna visibilidade dos recursos progressivos
 */
function toggleProgressiveFeatures() {
    const progressiveSection = document.getElementById('progressive-loading-section');
    const cacheSection = document.getElementById('cache-stats-section');
    
    if (progressiveSection.style.display === 'none') {
        progressiveSection.style.display = 'block';
        progressiveSection.classList.add('progressive-fade-in');
        
        // Inicializar indicadores de est√°gio se dispon√≠vel
        if (progressiveUI) {
            progressiveUI.createStageIndicators('progressive-stages-container');
        }
        
        showNotification('Recursos avan√ßados ativados', 'success');
    } else {
        progressiveSection.style.display = 'none';
        cacheSection.style.display = 'none';
        showNotification('Recursos avan√ßados desativados', 'info');
    }
}

/**
 * Inicia carregamento progressivo
 */
async function startProgressiveLoad() {
    if (!window.loadDashboardProgressively) {
        showNotification('Carregamento progressivo n√£o dispon√≠vel', 'warning');
        return;
    }
    
    try {
        const progressContainer = document.getElementById('progressive-stages-container');
        const infoContainer = document.getElementById('progressive-info-container');
        
        // Configurar callbacks
        const options = {
            onProgress: (percentage, message) => {
                console.log(`Progresso: ${percentage}% - ${message}`);
                if (progressiveUI) {
                    // Atualizar indicadores visuais
                    const currentStage = Math.floor((percentage / 100) * progressiveLoader.stages.length);
                    progressiveUI.updateStageIndicators(currentStage, progressiveLoader.stages);
                }
            },
            onComplete: (data) => {
                console.log('Carregamento progressivo conclu√≠do:', data);
                
                // Mostrar informa√ß√µes de progresso
                if (progressiveUI && data) {
                    progressiveUI.showProgressInfo('progressive-info-container', data);
                }
                
                showNotification('Dados carregados com sucesso!', 'success');
                
                // Atualizar p√°gina se necess√°rio
                if (data.stats) {
                    updateDashboardStats(data.stats);
                }
            },
            onError: (error) => {
                console.error('Erro no carregamento progressivo:', error);
                showNotification(`Erro: ${error.message}`, 'error');
            }
        };
        
        // Iniciar carregamento
        await window.loadDashboardProgressively(options);
        
    } catch (error) {
        console.error('Erro ao iniciar carregamento progressivo:', error);
        showNotification(`Erro: ${error.message}`, 'error');
    }
}

/**
 * Mostra estat√≠sticas de cache
 */
async function showCacheStats() {
    const cacheSection = document.getElementById('cache-stats-section');
    const container = document.getElementById('cache-stats-container');
    
    try {
        const stats = await window.getCacheStats();
        
        if (!stats || stats.status === 'unavailable') {
            showNotification('Estat√≠sticas de cache n√£o dispon√≠veis', 'warning');
            return;
        }
        
        // Mostrar se√ß√£o
        cacheSection.style.display = 'block';
        cacheSection.classList.add('progressive-fade-in');
        
        // Renderizar estat√≠sticas
        renderCacheStats(container, stats);
        
        showNotification('Estat√≠sticas de cache carregadas', 'success');
        
    } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
        showNotification(`Erro: ${error.message}`, 'error');
    }
}

/**
 * Renderiza estat√≠sticas de cache
 */
function renderCacheStats(container, stats) {
    const cacheStats = stats.cache_stats || {};
    const syncStatus = stats.sync_status || [];
    
    container.innerHTML = `
        <div class="cache-stat-card">
            <div class="cache-stat-value">${cacheStats.local_cache_entries || 0}</div>
            <div class="cache-stat-label">Cache Local</div>
        </div>
        <div class="cache-stat-card success">
            <div class="cache-stat-value">${cacheStats.supabase_cache_entries || 0}</div>
            <div class="cache-stat-label">Cache Persistente</div>
        </div>
        <div class="cache-stat-card warning">
            <div class="cache-stat-value">${Object.keys(cacheStats.cache_by_type || {}).length}</div>
            <div class="cache-stat-label">Tipos de Dados</div>
        </div>
        <div class="cache-stat-card">
            <div class="cache-stat-value">${syncStatus.length}</div>
            <div class="cache-stat-label">Sincroniza√ß√µes</div>
        </div>
    `;
}

/**
 * Limpa cache inteligente
 */
async function clearIntelligentCache() {
    if (!confirm('Tem certeza que deseja limpar o cache inteligente? Isso pode afetar a performance temporariamente.')) {
        return;
    }
    
    try {
        const success = await window.clearIntelligentCache();
        
        if (success) {
            showNotification('Cache inteligente limpo com sucesso', 'success');
            
            // Recarregar estat√≠sticas se vis√≠veis
            if (document.getElementById('cache-stats-section').style.display !== 'none') {
                setTimeout(() => showCacheStats(), 1000);
            }
        } else {
            showNotification('Erro ao limpar cache', 'error');
        }
        
    } catch (error) {
        console.error('Erro ao limpar cache:', error);
        showNotification(`Erro: ${error.message}`, 'error');
    }
}

/**
 * Carrega estat√≠sticas de cache automaticamente se dispon√≠vel
 */
async function loadCacheStatsIfAvailable() {
    try {
        if (window.getCacheStats) {
            const stats = await window.getCacheStats();
            if (stats && stats.status === 'success') {
                console.log('üìä Estat√≠sticas de cache dispon√≠veis:', stats);
            }
        }
    } catch (error) {
        console.log('Cache inteligente n√£o dispon√≠vel:', error.message);
    }
}

/**
 * Atualiza estat√≠sticas do dashboard
 */
function updateDashboardStats(stats) {
    // Implementar atualiza√ß√£o das estat√≠sticas na interface
    console.log('Atualizando estat√≠sticas do dashboard:', stats);
}

/**
 * Mostra notifica√ß√£o
 */
function showNotification(message, type = 'info') {
    // Criar elemento de notifica√ß√£o
    const notification = document.createElement('div');
    notification.className = `loading-feedback ${type} show`;
    notification.innerHTML = `
        <i class="feedback-icon fas ${getIconForType(type)}"></i>
        <span class="feedback-text">${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    // Remover ap√≥s 3 segundos
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

/**
 * Retorna √≠cone baseado no tipo
 */
function getIconForType(type) {
    switch (type) {
        case 'success': return 'fa-check-circle';
        case 'error': return 'fa-exclamation-circle';
        case 'warning': return 'fa-exclamation-triangle';
        default: return 'fa-info-circle';
    }
}
</script>
{% endblock %}